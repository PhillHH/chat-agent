<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>PolarisDX - WebSocket Chat</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
        #chat-box { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 1rem; margin-bottom: 1rem; background: #f9f9f9; }
        .message { margin-bottom: 0.5rem; padding: 0.5rem; border-radius: 4px; max-width: 80%; }
        .user { background: #e0f7fa; text-align: right; margin-left: auto; }
        .bot { background: #fff3e0; text-align: left; margin-right: auto; }
        .agent { background: #e8f5e9; border: 1px solid #4caf50; text-align: left; margin-right: auto; }
        .system { background: #eee; text-align: center; font-style: italic; font-size: 0.8rem; width: 100%; }
        input[type="text"] { width: 70%; padding: 0.5rem; }
        button { padding: 0.5rem 1rem; }
        #status { font-size: 0.8rem; color: #666; margin-bottom: 0.5rem; }
    </style>
</head>
<body>
    <h1>Secure PolarisDX Chat (v2 WebSocket)</h1>
    <div id="status">Verbinde...</div>
    <div id="chat-box"></div>
    <div style="display: flex; gap: 0.5rem;">
        <input type="text" id="user-input" placeholder="Nachricht eingeben..." />
        <button onclick="sendMessage()">Senden</button>
    </div>

    <script>
        const sessionId = "sess_" + Math.random().toString(36).substr(2, 9);
        const chatBox = document.getElementById('chat-box');
        const inputField = document.getElementById('user-input');
        const statusDiv = document.getElementById('status');

        // WebSocket URL (automatisch basierend auf aktuellem Host)
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${protocol}//${window.location.host}/chat/ws/${sessionId}`;

        let socket;
        let currentBotMessageDiv = null;

        function connect() {
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                statusDiv.textContent = "Verbunden (Session: " + sessionId + ")";
                statusDiv.style.color = "green";
            };

            socket.onclose = () => {
                statusDiv.textContent = "Verbindung getrennt. Reconnecting...";
                statusDiv.style.color = "red";
                setTimeout(connect, 3000);
            };

            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (e) {
                    console.log("Raw text received:", event.data);
                }
            };
        }

        function handleMessage(data) {
            if (data.type === "chunk") {
                if (!currentBotMessageDiv) {
                    currentBotMessageDiv = createMessageDiv("bot");
                }
                currentBotMessageDiv.textContent += data.text;
                scrollToBottom();
            } else if (data.type === "done") {
                currentBotMessageDiv = null;
            } else if (data.type === "agent_message") {
                const div = createMessageDiv("agent");
                div.innerHTML = `<strong>${data.sender}:</strong> ${data.text}`;
                scrollToBottom();
            } else if (data.type === "system") {
                const div = createMessageDiv("system");
                div.textContent = data.text;
                scrollToBottom();
            } else if (data.type === "error") {
                const div = createMessageDiv("system");
                div.style.color = "red";
                div.textContent = "Error: " + data.text;
                scrollToBottom();
            }
        }

        function createMessageDiv(type) {
            const div = document.createElement('div');
            div.classList.add('message', type);
            chatBox.appendChild(div);
            return div;
        }

        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function sendMessage() {
            const text = inputField.value.trim();
            if (!text || !socket || socket.readyState !== WebSocket.OPEN) return;

            const div = createMessageDiv("user");
            div.textContent = text;
            scrollToBottom();

            socket.send(JSON.stringify({ message: text }));
            inputField.value = '';
        }

        inputField.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        });

        // Start
        connect();
    </script>
</body>
</html>
