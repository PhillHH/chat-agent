<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Secure AI Gateway - Test Chat</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
        #chat-box { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 1rem; margin-bottom: 1rem; background: #f9f9f9; }
        .message { margin-bottom: 0.5rem; padding: 0.5rem; border-radius: 4px; }
        .user { background: #e0f7fa; text-align: right; }
        .bot { background: #fff3e0; text-align: left; }
        .system { background: #eee; text-align: center; font-style: italic; font-size: 0.8rem; }
        input[type="text"] { width: 70%; padding: 0.5rem; }
        button { padding: 0.5rem 1rem; }
    </style>
</head>
<body>
    <h1>Secure AI Gateway Test</h1>
    <div id="chat-box"></div>
    <div style="display: flex; gap: 0.5rem;">
        <input type="text" id="user-input" placeholder="Nachricht eingeben..." />
        <button onclick="sendMessage()">Senden</button>
    </div>

    <script>
        // Einfache Session-ID generieren
        const sessionId = "sess_" + Math.random().toString(36).substr(2, 9);

        const chatBox = document.getElementById('chat-box');
        const inputField = document.getElementById('user-input');

        function appendMessage(text, sender) {
            const div = document.createElement('div');
            div.classList.add('message', sender);
            div.textContent = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const text = inputField.value.trim();
            if (!text) return;

            appendMessage(text, 'user');
            inputField.value = '';

            try {
                const response = await fetch('/chat/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        message: text
                    })
                });

                if (!response.ok) {
                    throw new Error("API Error: " + response.statusText);
                }

                const data = await response.json();
                appendMessage(data.response, 'bot');

                if (data.status === 'ESCALATION_NEEDED') {
                    appendMessage("⚠️ Eskalation an Teams ausgelöst.", 'system');
                } else if (data.status === 'HUMAN_MODE') {
                    appendMessage("ℹ️ Human Mode aktiv.", 'system');
                }

            } catch (err) {
                appendMessage("Fehler: " + err.message, 'system');
            }
        }

        inputField.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        });
    </script>
</body>
</html>
